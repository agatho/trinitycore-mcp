/**
 * {{className}} - {{description}}
 *
 * Auto-generated by TrinityCore MCP Server
 * Generation date: {{generationDate}}
 * Template: packet_handler.hbs
 *
 * Opcode: {{opcode}}
 * Direction: {{direction}}
 * Thread-safety: Packet-based (thread-safe)
 */

#pragma once

#include "Session/BotSession.h"
#include "WorldPacket.h"
{{#if includeSpellPackets}}
#include "Packets/SpellPacketBuilder.h"
{{/if}}
{{#if includeMovementPackets}}
#include "Packets/MovementPacketBuilder.h"
{{/if}}

{{#if namespace}}
namespace {{namespace}} {
{{/if}}

/**
 * {{className}}
 * {{description}}
 *
 * Handles: {{opcode}}
 * Size: {{#if fixedSize}}{{packetSize}} bytes (fixed){{else}}Variable{{/if}}
 * Frequency: {{frequency}}
 */
class {{className}} {
public:
    /**
     * Handle incoming packet
     * @param session Bot session receiving the packet
     * @param packet Packet data
     */
    static void Handle(BotSession* session, WorldPacket& packet);

{{#if needsBuilder}}
    /**
     * Build outgoing packet
     * @param session Bot session sending the packet
     {{#each builderParams}}
     * @param {{this.name}} {{this.description}}
     {{/each}}
     * @return Constructed packet ready to send
     */
    static WorldPacket Build(BotSession* session{{#each builderParams}}, {{this.type}} {{this.name}}{{/each}});
{{/if}}

private:
    // Packet structure
    struct PacketData {
{{#each fields}}
        {{this.type}} {{this.name}}{{#if this.defaultValue}} = {{this.defaultValue}}{{/if}};  // {{this.description}}
{{/each}}
    };

    // Helper methods
    static bool ValidatePacket(const PacketData& data);
    static void ProcessPacket(BotSession* session, const PacketData& data);

{{#if includeLogging}}
    static void LogPacket(const PacketData& data, bool incoming);
{{/if}}
};

{{#if namespace}}
} // namespace {{namespace}}
{{/if}}

// Implementation
{{#if namespace}}
namespace {{namespace}} {
{{/if}}

void {{className}}::Handle(BotSession* session, WorldPacket& packet) {
    if (!session || !session->GetBot())
        return;

    PacketData data;

    // Read packet fields
{{#each fields}}
    {{#if this.isGuid}}
    packet >> data.{{this.name}};
    {{else if this.isString}}
    packet >> data.{{this.name}};
    {{else if this.isArray}}
    for (uint32 i = 0; i < {{this.arraySize}}; ++i)
        packet >> data.{{this.name}}[i];
    {{else}}
    packet >> data.{{this.name}};
    {{/if}}
{{/each}}

{{#if includeLogging}}
    LogPacket(data, true);
{{/if}}

    // Validate packet data
    if (!ValidatePacket(data)) {
        TC_LOG_ERROR("playerbot", "{{className}}: Invalid packet data from bot {}",
                     session->GetBot()->GetName());
        return;
    }

    // Process packet
    ProcessPacket(session, data);
}

{{#if needsBuilder}}
WorldPacket {{className}}::Build(BotSession* session{{#each builderParams}}, {{this.type}} {{this.name}}{{/each}}) {
    WorldPacket packet({{opcode}}{{#if fixedSize}}, {{packetSize}}{{/if}});

    PacketData data;
{{#each builderParams}}
    data.{{this.name}} = {{this.name}};
{{/each}}

    // Write packet fields
{{#each fields}}
    {{#if this.isGuid}}
    packet << data.{{this.name}};
    {{else if this.isString}}
    packet << data.{{this.name}};
    {{else if this.isArray}}
    for (uint32 i = 0; i < {{this.arraySize}}; ++i)
        packet << data.{{this.name}}[i];
    {{else}}
    packet << data.{{this.name}};
    {{/if}}
{{/each}}

{{#if includeLogging}}
    LogPacket(data, false);
{{/if}}

    return packet;
}
{{/if}}

bool {{className}}::ValidatePacket(const PacketData& data) {
{{#if hasValidation}}
    // Validate packet fields
{{#each validations}}
    if (!({{this.condition}})) {
        TC_LOG_ERROR("playerbot", "{{../className}}: Validation failed - {{this.message}}");
        return false;
    }
{{/each}}
{{/if}}
    return true;
}

void {{className}}::ProcessPacket(BotSession* session, const PacketData& data) {
    Player* bot = session->GetBot();
    if (!bot)
        return;

{{#if customProcessing}}
    {{customProcessing}}
{{else}}
    // Default packet processing
    TC_LOG_DEBUG("playerbot", "{{className}}: Processing packet for bot {}", bot->GetName());

{{#if isMovementPacket}}
    // Update bot position
    bot->UpdatePosition(data.position);
{{/if}}

{{#if isSpellPacket}}
    // Handle spell cast
    if (data.spellId) {
        SpellPacketBuilder builder;
        builder.CastSpell(bot, data.spellId, data.target);
    }
{{/if}}

{{#if isAuraPacket}}
    // Handle aura update
    if (data.auraId) {
        if (data.remove) {
            bot->RemoveAura(data.auraId);
        } else {
            // Apply aura via packet
        }
    }
{{/if}}

{{#if isItemPacket}}
    // Handle item interaction
    if (data.itemGuid) {
        Item* item = bot->GetItemByGuid(data.itemGuid);
        if (item) {
            // Process item action
        }
    }
{{/if}}
{{/if}}
}

{{#if includeLogging}}
void {{className}}::LogPacket(const PacketData& data, bool incoming) {
    std::string direction = incoming ? "RECV" : "SEND";
    TC_LOG_TRACE("playerbot.packets", "{} {{opcode}}:", direction);
{{#each fields}}
    {{#if this.isGuid}}
    TC_LOG_TRACE("playerbot.packets", "  {{this.name}}: {}", data.{{this.name}}.ToString());
    {{else if this.isString}}
    TC_LOG_TRACE("playerbot.packets", "  {{this.name}}: {}", data.{{this.name}});
    {{else}}
    TC_LOG_TRACE("playerbot.packets", "  {{this.name}}: {}", data.{{this.name}});
    {{/if}}
{{/each}}
}
{{/if}}

{{#if namespace}}
} // namespace {{namespace}}
{{/if}}
