api:
  class: WorldSession
  method: HandleTrainerBuySpellOpcode
  signature: void WorldSession::HandleTrainerBuySpellOpcode(WorldPackets::NPC::TrainerBuySpell
    & packet)
documentation:
  brief: Processes a client request to purchase a spell from a trainer.
  description: Handles the opcode sent by the client when attempting to buy a spell
    from a trainer. This method validates the player's ability to learn the spell,
    checks if the trainer has the spell available, verifies that the player has sufficient
    gold, and then deducts the cost and teaches the spell to the player. The method
    ensures proper game balance and progression mechanics by enforcing prerequisites
    such as skill levels, reputation requirements, and trainer availability.
  parameters: []
  returns: null
  examples:
  - title: Basic Spell Purchase
    code: "void WorldSession::HandleTrainerBuySpellOpcode(WorldPackets::NPC::TrainerBuySpell&\
      \ packet)\n{\n    // Validate trainer and spell\n    if (!trainer || !trainer->HasSpell(packet.SpellId))\n\
      \        return;\n    \n    // Check player can learn spell\n    if (!player->CanLearnSpell(packet.SpellId))\n\
      \        return;\n    \n    // Deduct cost and teach spell\n    player->ModifyMoney(-spellCost);\n\
      \    player->LearnSpell(packet.SpellId);\n}"
    language: cpp
  notes: This method is part of the core NPC trainer interaction system. It should
    only be called from the main game loop and assumes proper client validation has
    already occurred. The method handles all necessary checks internally including
    gold deduction, spell learning, and packet sending for success/failure responses.
  warnings: Do not call this method directly without ensuring the player is in a valid
    state to interact with trainers. Improper handling may lead to gold duplication
    or unlearnable spells. Ensure proper error handling for cases where the player
    cannot afford or learn the spell.
  related:
  - HandleTrainerListOpcode
  - CanLearnSpell
  - LearnSpell
  - ModifyMoney
metadata:
  confidence: 0.95
  generated_at: '2025-11-04T20:12:32.251925'
  generator: lmstudio-qwen3-coder-30b
  version: 1.0.0
  source: core
